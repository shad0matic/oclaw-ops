generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  schemas  = ["memory", "ops"]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model agent_profiles {
  id               Int       @id @default(autoincrement())
  agent_id         String    @unique
  name             String
  level            Int?      @default(1) @db.SmallInt
  trust_score      Decimal?  @default(0.50) @db.Decimal(3, 2)
  total_tasks      Int?      @default(0)
  successful_tasks Int?      @default(0)
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)
  tasks            tasks[]

  @@schema("memory")
}

model daily_notes {
  id         BigInt                 @id @default(autoincrement())
  note_date  DateTime               @unique @db.Date
  content    String
  embedding  Unsupported("vector")?
  created_at DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at DateTime?              @default(now()) @db.Timestamptz(6)

  @@index([embedding])
  @@schema("memory")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model memories {
  id          BigInt                 @id @default(autoincrement())
  content     String
  embedding   Unsupported("vector")?
  tags        String[]               @default([])
  importance  Int?                   @default(5) @db.SmallInt
  source_file String?
  agent_id    String?                @default("main")
  created_at  DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?              @default(now()) @db.Timestamptz(6)

  @@index([agent_id], map: "idx_memories_agent")
  @@index([created_at(sort: Desc)], map: "idx_memories_created")
  @@index([tags], map: "idx_memories_tags", type: Gin)
  @@index([embedding])
  @@schema("memory")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model performance_reviews {
  id             Int       @id @default(autoincrement())
  agent_id       String
  reviewer       String?   @default("kevin")
  output_summary String?
  rating         Int?      @db.SmallInt
  level_before   Int?      @db.SmallInt
  level_after    Int?      @db.SmallInt
  feedback       String?
  created_at     DateTime? @default(now()) @db.Timestamptz(6)

  @@schema("memory")
}

model agent_events {
  id          BigInt    @id @default(autoincrement())
  agent_id    String
  event_type  String
  detail      Json?     @default("{}")
  session_key String?
  tokens_used Int?
  cost_usd    Decimal?  @db.Decimal(10, 6)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  context_id  BigInt?
  runs        runs?     @relation(fields: [context_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([agent_id, created_at(sort: Desc)], map: "idx_events_agent")
  @@index([event_type], map: "idx_events_type")
  @@schema("ops")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model runs {
  id                     BigInt             @id @default(autoincrement())
  workflow_id            Int?
  workflow_name          String
  task                   String?
  status                 String?            @default("pending")
  triggered_by           String?            @default("manual")
  context                Json?              @default("{}")
  result                 Json?              @default("{}")
  started_at             DateTime?          @db.Timestamptz(6)
  completed_at           DateTime?          @db.Timestamptz(6)
  created_at             DateTime?          @default(now()) @db.Timestamptz(6)
  agent_id               String?            @default("main")
  last_heartbeat         DateTime?          @db.Timestamptz(6)
  heartbeat_msg          String?
  timeout_seconds        Int?               @default(600)
  session_key            String?
  source_feature_request String?
  review_iteration       Int?               @default(0)
  review_feedback        String?
  agent_events           agent_events[]
  workflows              workflows?         @relation(fields: [workflow_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  steps                  steps[]
  task_assignments       task_assignments[]
  tasks                  tasks[]

  @@index([status, created_at(sort: Desc)], map: "idx_runs_status")
  @@index([workflow_id], map: "idx_runs_workflow")
  @@index([agent_id, status], map: "idx_runs_agent_status")
  @@schema("ops")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model steps {
  id           BigInt    @id @default(autoincrement())
  run_id       BigInt
  step_name    String
  step_order   Int
  agent_id     String    @default("main")
  status       String?   @default("pending")
  input        Json?     @default("{}")
  output       Json?     @default("{}")
  error        String?
  retries      Int?      @default(0)
  max_retries  Int?      @default(2)
  started_at   DateTime? @db.Timestamptz(6)
  completed_at DateTime? @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  runs         runs      @relation(fields: [run_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tasks        tasks[]

  @@index([run_id, step_order], map: "idx_steps_run")
  @@index([status], map: "idx_steps_status")
  @@schema("ops")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model tasks {
  id           BigInt    @id @default(autoincrement())
  task_type    String
  payload      Json      @default("{}")
  status       String?   @default("pending")
  priority     Int?      @default(5) @db.SmallInt
  claimed_by   String?
  group_key    String?
  visible_at   DateTime? @default(now()) @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  completed_at DateTime? @db.Timestamptz(6)
  run_id       BigInt?
  step_id      BigInt?
  agent_id     String?
  runs         runs?     @relation(fields: [run_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  steps        steps?    @relation(fields: [step_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  agent_profile agent_profiles? @relation(fields: [agent_id], references: [agent_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([status, priority(sort: Desc), visible_at], map: "idx_tasks_status")
  @@schema("ops")
}

model workflows {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  description     String?
  yaml_definition String
  version         Int?      @default(1)
  enabled         Boolean?  @default(true)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)
  runs            runs[]

  @@schema("ops")
}

model compounds {
  id            BigInt                 @id @default(autoincrement())
  period_start  DateTime               @db.Date
  period_end    DateTime               @db.Date
  summary       String
  key_learnings String[]
  mistakes      String[]
  embedding     Unsupported("vector")?
  agent_id      String?                @default("main")
  created_at    DateTime?              @default(now()) @db.Timestamptz(6)

  @@index([period_start, period_end], map: "idx_compounds_period")
  @@schema("memory")
}

model entities {
  id                                                    BigInt                 @id @default(autoincrement())
  name                                                  String
  entity_type                                           String                 @default("unknown")
  aliases                                               String[]               @default([])
  properties                                            Json?                  @default("{}")
  embedding                                             Unsupported("vector")?
  first_seen_by                                         String?
  created_at                                            DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at                                            DateTime?              @default(now()) @db.Timestamptz(6)
  entity_relations_entity_relations_source_idToentities entity_relations[]     @relation("entity_relations_source_idToentities")
  entity_relations_entity_relations_target_idToentities entity_relations[]     @relation("entity_relations_target_idToentities")

  @@unique([name, entity_type])
  @@index([aliases], map: "idx_entities_aliases", type: Gin)
  @@index([embedding], map: "idx_entities_embedding")
  @@index([entity_type], map: "idx_entities_type")
  @@schema("memory")
}

model entity_relations {
  id                                            BigInt    @id @default(autoincrement())
  source_id                                     BigInt?
  target_id                                     BigInt?
  relation_type                                 String
  strength                                      Decimal?  @default(0.50) @db.Decimal(3, 2)
  context                                       String?
  agent_id                                      String?
  created_at                                    DateTime? @default(now()) @db.Timestamptz(6)
  entities_entity_relations_source_idToentities entities? @relation("entity_relations_source_idToentities", fields: [source_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  entities_entity_relations_target_idToentities entities? @relation("entity_relations_target_idToentities", fields: [target_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([source_id, target_id, relation_type])
  @@index([source_id], map: "idx_entity_relations_source")
  @@index([target_id], map: "idx_entity_relations_target")
  @@schema("memory")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model mistakes {
  id               BigInt    @id @default(autoincrement())
  agent_id         String
  description      String
  context          String?
  lesson_learned   String?
  severity         Int?      @default(3) @db.SmallInt
  recurrence_count Int?      @default(1)
  last_occurred_at DateTime? @default(now()) @db.Timestamptz(6)
  resolved         Boolean?  @default(false)
  created_at       DateTime? @default(now()) @db.Timestamptz(6)

  @@index([agent_id], map: "idx_mistakes_agent")
  @@schema("memory")
}

model cost_snapshots {
  id            BigInt    @id @default(autoincrement())
  snapshot_hour DateTime  @db.Timestamptz(6)
  fixed_eur     Decimal?  @default(0) @db.Decimal(10, 4)
  variable_eur  Decimal?  @default(0) @db.Decimal(10, 4)
  total_eur     Decimal?  @default(0) @db.Decimal(10, 4)
  breakdown     Json?     @default("{}")
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([snapshot_hour(sort: Desc)], map: "idx_cost_snapshots_hour")
  @@schema("ops")
}

model cross_signals {
  id          BigInt      @id @default(autoincrement())
  priority_id BigInt?
  agent_id    String
  source      String?
  snippet     String?
  confidence  Decimal?    @default(0.50) @db.Decimal(3, 2)
  created_at  DateTime?   @default(now()) @db.Timestamptz(6)
  priorities  priorities? @relation(fields: [priority_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([agent_id], map: "idx_cross_signals_agent")
  @@index([priority_id], map: "idx_cross_signals_priority")
  @@schema("ops")
}

model fx_rates {
  id         Int       @id @default(autoincrement())
  rate_date  DateTime  @unique @db.Date
  usd_to_eur Decimal   @db.Decimal(10, 6)
  source     String?   @default("ecb")
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([rate_date(sort: Desc)], map: "idx_fx_rates_date")
  @@schema("ops")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model priorities {
  id            BigInt          @id @default(autoincrement())
  entity        String
  entity_type   String          @default("topic")
  priority      Int?            @default(5) @db.SmallInt
  context       String?
  reported_by   String
  confirmed_by  String[]
  signal_count  Int?            @default(1)
  last_seen_at  DateTime?       @default(now()) @db.Timestamptz(6)
  created_at    DateTime?       @default(now()) @db.Timestamptz(6)
  resolved_at   DateTime?       @db.Timestamptz(6)
  cross_signals cross_signals[]

  @@unique([entity, entity_type])
  @@index([entity_type], map: "idx_priorities_entity_type")
  @@schema("ops")
}

model reactions {
  id              Int       @id @default(autoincrement())
  trigger_agent   String
  trigger_event   String
  trigger_filter  Json?     @default("{}")
  responder_agent String
  action          String
  action_params   Json?     @default("{}")
  probability     Decimal?  @default(1.00) @db.Decimal(3, 2)
  enabled         Boolean?  @default(true)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  @@schema("ops")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model subscriptions {
  id               Int       @id @default(autoincrement())
  name             String    @unique
  provider         String?
  monthly_price    Decimal   @db.Decimal(10, 2)
  currency         String?   @default("EUR")
  used_in_openclaw Boolean?  @default(true)
  active           Boolean?  @default(true)
  renewal_day      Int?      @default(1) @db.SmallInt
  notes            String?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)

  @@schema("ops")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model system_metrics {
  id               BigInt   @id @default(autoincrement())
  ts               DateTime @default(now()) @db.Timestamptz(6)
  cpu_pct          Float    @db.Real
  mem_used_bytes   BigInt
  mem_total_bytes  BigInt
  disk_used_bytes  BigInt?
  disk_total_bytes BigInt?
  db_size_bytes    BigInt?
  db_connections   Int?

  @@index([ts(sort: Desc)], map: "idx_system_metrics_ts")
  @@schema("ops")
}

model file_claims {
  id          BigInt    @id @default(autoincrement())
  agent_id    String
  file_path   String
  description String?
  claimed_at  DateTime? @default(now()) @db.Timestamptz(6)
  released_at DateTime? @db.Timestamptz(6)

  @@schema("ops")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model task_queue {
  id           BigInt    @id @default(autoincrement())
  title        String
  description  String?
  project      String    @default("infra")
  agent_id     String?
  priority     Int?      @default(5) @db.SmallInt
  status       String?   @default("queued")
  created_by   String?   @default("boss")
  result       Json?     @default("{}")
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  started_at   DateTime? @db.Timestamptz(6)
  completed_at DateTime? @db.Timestamptz(6)

  @@index([project, status], map: "idx_task_queue_project")
  @@index([status, priority(sort: Desc)], map: "idx_task_queue_status")
  @@schema("ops")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model task_assignments {
  id                     BigInt             @id @default(autoincrement())
  agent_id               String
  repo                   String
  branch                 String
  worktree_path          String?
  description            String
  file_manifest          String[]           @default([])
  status                 String             @default("assigned")
  parent_task_id         BigInt?
  run_id                 BigInt?
  created_at             DateTime?          @default(now()) @db.Timestamptz(6)
  started_at             DateTime?          @db.Timestamptz(6)
  completed_at           DateTime?          @db.Timestamptz(6)
  task_assignments       task_assignments?  @relation("task_assignmentsTotask_assignments", fields: [parent_task_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_task_assignments task_assignments[] @relation("task_assignmentsTotask_assignments")
  runs                   runs?              @relation(fields: [run_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("ops")
}

model task_runs {
  id                 BigInt    @id @default(autoincrement())
  task_id            String?
  session_key        String?
  agent_id           String    @default("main")
  tier               Int?
  initial_tier       Int?
  model_used         String
  model_alias        String?
  task_type          String?
  task_description   String?
  status             String?   @default("running")
  input_tokens       Int?
  output_tokens      Int?
  total_tokens       Int?
  cost_usd           Decimal?  @db.Decimal(10, 6)
  cost_eur           Decimal?  @db.Decimal(10, 6)
  estimated_tier     Int?
  estimated_tokens   Int?
  estimated_cost_usd Decimal?  @db.Decimal(10, 6)
  escalated_from     Int?
  escalation_reason  String?
  escalation_history Json?     @default("[]")
  duration_ms        Int?
  started_at         DateTime? @default(now()) @db.Timestamptz
  completed_at       DateTime? @db.Timestamptz
  created_at         DateTime? @default(now()) @db.Timestamptz

  @@schema("ops")
}

model cost_estimates {
  id                       BigInt    @id @default(autoincrement())
  task_run_id              BigInt?
  predicted_input_tokens   Int?
  predicted_output_tokens  Int?
  predicted_cost_usd       Decimal?  @db.Decimal(10, 6)
  actual_input_tokens      Int?
  actual_output_tokens     Int?
  actual_cost_usd          Decimal?  @db.Decimal(10, 6)
  input_features           Json?
  prediction_model_version String?   @default("heuristic_v1")
  accuracy_pct             Decimal?  @db.Decimal(5, 2)
  created_at               DateTime? @default(now()) @db.Timestamptz
  updated_at               DateTime? @default(now()) @db.Timestamptz

  @@schema("ops")
}
